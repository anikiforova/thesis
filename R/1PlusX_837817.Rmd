---
title: "1PlusX_837817"
author: "Ana Dimitrova"
date: "7/24/2018"
output: pdf_document
geometry: margin=1cm
---
 

```{r setup, include=TRUE, echo=FALSE}
library(ggplot2)
library(scales)
library(gridExtra)

campaign_id = 837817
path = paste("~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/", campaign_id, "/", sep="")
path_ctr = paste("~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/CTR/", campaign_id, "/", sep="")
plot_results <- function(algorith_name="Random") {
  
  data <- read.csv(file=paste0(path, paste0(algorith_name, ".csv")), header=TRUE, sep=",")
  data$Percent = data$Clicks / data$Impressions * 100
  data$Factor = paste(data$Method, sep=" ")

  ggplot(data, aes(x=TotalImpressions, y=Percent, colour=Factor)) + 
    stat_smooth(aes(x = TotalImpressions, y = Percent), method = "lm",
                formula = y ~ poly(x, 10), se = FALSE) +
    xlab("Impressions") + ylab("% of Clicks") +
    #expand_limits(y=c(4,7.5), x=c(0, 225000)) + 
    theme_bw() + ggtitle(algorith_name)
}

formatterM <- function(){
  function(x) paste(x/1000000, "M")
}

formatterPretty <- function(){
  function(x) ifelse(x==10, paste(x, "% (Random)"), paste(x, "%"))
}

selectNecessaryColumns <- function(df, columns) {
  for (column in columns) {
    if(!(column %in% colnames(df))){
      df[column] = NA
    } 
  }
  df[,columns]
}

prepData <- function(files, cur_path=path) {
  file=paste0(cur_path, paste0(files[1], ".csv"))
  data <- read.csv(file=paste0(cur_path, paste0(files[1], ".csv")), header=TRUE, sep=",")
  columns = c("Clicks", "Impressions", "RecommendationPart","TotalImpressions","Method", "Alpha","Timestamp","TrainPart", "MSE", "CumulativeMSE","MMSE", "MCumulativeMSE", "Nu", "Hours", "LengthScale", "ClusterCount","EqClicks","LearningRate")
  data = selectNecessaryColumns(data, columns)
  if(length(files) > 1){
    for (name in files){
      data1 <- read.csv(file=paste0(cur_path, paste0(name, ".csv")), header=TRUE, sep=",")
      data1 = selectNecessaryColumns(data1, columns)
      data <- rbind(data, data1)  
    }
  }
  data$Percent = data$Clicks / data$Impressions * 100
  data$Factor = factor(paste(data$Method, " ", data$Alpha, " R:", data$RecommendationPart * 100, sep=""))
  data$UserPercentage = factor(data$RecommendationPart * 100)
  #data$Timestamp = data$Timestamp / 1000
  data$Timestamp = as.POSIXct(data$Timestamp, origin="1970-01-01")
  data
}
  
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

plotGroup <- function(g1, g2, title) {
  mylegend<-g_legend(g2)
  grid.arrange(arrangeGrob(g1 + theme(legend.position="none"),
                           g2 + theme(legend.position="none"),
                                 nrow=1, ncol=2, widths=unit(c(9, 9), "cm"), heights=unit(9, "cm")),
                mylegend, nrow=2, widths=unit(18, "cm"), heights=unit(c(9, 1), "cm"),
                top = title)
}

plotGroup3 <- function(g1, g2, g3, title) {
  grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(9, 9, 9), "cm"), heights=unit(9, "cm"), top = title)
}

getCTRPlot <- function(data, limits = c(0,1.5), scaleName="") {
  g1 = ggplot(data, aes(x=TotalImpressions, y=Percent, colour=Factor)) + 
    geom_line() +
    xlab("Impressions") + ylab("CTR") +
    expand_limits(y=limits) + 
    scale_x_continuous(labels=formatterM()) + 
    theme_bw() +
    theme(plot.title = element_text(size = 10, face = "bold"), 
          legend.title=element_text(size=8), 
          legend.text=element_text(size=8), 
          legend.key.size = unit(1,"line")) +
    scale_color_discrete(name=scaleName)+
    theme(legend.position="bottom")
  
  g1
}

getMSEPlot <- function(data, xLimit, scaleName) {
  g2 = ggplot(data, aes(x=TotalImpressions, y=MMSE, colour=Factor)) + 
  stat_smooth(aes(y=MMSE, colour=Factor), method = "lm", formula = y ~ poly(x, 10), se = FALSE) +
    xlab("Impressions") + ylab("MMSE") +
    expand_limits(y=xLimit) + 
    scale_x_continuous(labels=formatterM()) +
    theme_bw() +
    theme(legend.position="bottom")+
    scale_color_discrete(name=scaleName)
  g2
}
  
```

Comparison between CTR and MSE for Random when for assignment are used discrete values - {0,1} or float between [0, 1]. When doing the math for uniform distribution it's clear that the expectation should be a bit above 33% (since we have very few 1s we can approximate the error if we get only 0s). E[(0 - A)^2] = E[0^2] - E[0*A] + E[A^2] = var(A) + E[A]^2 = 1/12 + 1/4 = 1/3
And the expectation for the discrete values {0, 1} is clearly 0.5%. 
In terms of CTR both perform equally around 0.18.
```{r Random, include=TRUE, echo=FALSE}

files =  c("Random")
data = prepData(files)
data$Factor = factor(paste(data$Method," R:", data$RecommendationPart*100, "%", sep=""))

g1 = getCTRPlot(data, c(0,1), "")
g2 = getMSEPlot(data, c(0,1), "Model/Rec Size")

plotGroup(g1, g2, "Random - Evaluation of Rec. size and sampling choices.")
```

```{r GP_Clustered, include=TRUE, echo=FALSE}

files =  c("GP_Clustered_New")
data = prepData(files)

data$Factor = factor(paste(" Nu:", data$Nu, " H:", data$Hours, " LS:", data$LengthScale, " CL:", data$ClusterCount, " Eq:", data$EqClicks, sep = ""))

data = subset(data, Impressions > 1000)

g1 = getCTRPlot(data, c(0,0.75)) 
g2 = getMSEPlot(data, c(0,0.003), "")

plotGroup(g1, g2, "GP Evaluation of parameters and kernels")
```
```{r LinUCB, include=TRUE, echo=FALSE}

files =  c("LinUCB_Disjoint_New")
data = prepData(files)

data$Factor = factor(paste(" Rec:", data$RecommendationPart, " H:", data$Hours, " LS:", data$Alpha," Eq:", data$EqClicks, sep = ""))

data = subset(data, Impressions > 1000)

g1 = getCTRPlot(data, c(0,0.75)) 
g2 = getMSEPlot(data, c(0,0.003), "")

plotGroup(g1, g2, "GP Evaluation of parameters and kernels")
```

```{r NN, include=TRUE, echo=FALSE}

files =  c("NN_New")
data = prepData(files)


data = subset(data, Impressions > 1000)
data_rec = subset(data, EqClicks == 0.2 & LearningRate == 0.01)
data_rec$Factor = factor(paste(data_rec$RecommendationPart * 100, "%", sep = ""))

data_learning_rate = subset(data, EqClicks == 0.2 & RecommendationPart == 0.2)
data_learning_rate$Factor = factor(paste(data_learning_rate$LearningRate, sep = ""))

data_eq = subset(data, EqClicks == 0.5 & RecommendationPart == 0.2)
data_eq$Factor = factor(paste(data_eq$LearningRate, sep = ""))

g1 = getCTRPlot(data_rec, c(0,1), "Rec:")            + ggtitle("Rec Change-EQ:0.2")
g2 = getCTRPlot(data_learning_rate, c(0,1), "LRate:")+ ggtitle("LRate Change")
g3 = getCTRPlot(data_eq, c(0,1), "LRate:")           + ggtitle("LRate Change-EQ:0.5")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"))

#plotGroup(g1, g2, "NN Evaluation of parameters and kernels")
```

```{r Regression, include=TRUE, echo=FALSE}

files =  c("Regression_New")
data = prepData(files)

data$Factor = factor(paste(" Rec:", data$RecommendationPart, " H:", data$Hours, " LS:", data$Alpha," Eq:", data$EqClicks, sep = ""))

data = subset(data, Impressions > 1000)

g1 = getCTRPlot(data, c(0,0.75)) 
g2 = getMSEPlot(data, c(0,0.003), "")

plotGroup(g1, g2, "Regression Evaluation of parameters and kernels")
```

```{r TS_Lin, include=FALSE, echo=FALSE}

#files =  c("TS_Lin_New")
#data = prepData(files)

#data$Factor = factor(paste(" Rec:", data$RecommendationPart, " H:", data$Hours, " LS:", data$Alpha, sep = ""))

#data = subset(data, Impressions > 1000)

#g1 = getCTRPlot(data, c(0,0.75)) 
#g2 = getMSEPlot(data, c(0,0.003), "")

#plotGroup(g1, g2, "GP Evaluation of parameters and kernels")
```