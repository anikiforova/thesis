---
title: "1PlusX - Campaign 837817"
author: "Ana Dimitrova"
output: pdf_document
geometry: margin=1cm
---
 

```{r setup, include=TRUE, echo=FALSE,warning=FALSE}
library(ggplot2)
library(scales)
library(gridExtra)

campaign_id = 837817
imageLocation = "~/Documents/ETH/Thesis/1plusX/Data/thesis/1plusx/Results/Images/"
path = paste("~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/", campaign_id, "/", sep="")
path_ctr = paste("~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/CTR/", campaign_id, "/", sep="")

formatterM <- function(){
  function(x) paste(x/1000000, "M")
}
formatterPercent <- function(){
  function(x) paste(x, "%")
}
selectNecessaryColumns <- function(df, columns) {
  for (column in columns) {
    if(!(column %in% colnames(df))){
      df[column] = NA
    } 
  }
  df[,columns]
}

prepData <- function(files, cur_path=path) {
  file=paste0(cur_path, paste0(files[1], ".csv"))
  data <- read.csv(file=paste0(cur_path, paste0(files[1], ".csv")), header=TRUE, sep=",")
  columns = c("Clicks", "Impressions", "RecommendationPart","TotalImpressions","Method", "Alpha","Timestamp","TrainPart","BatchCTR","ModelCTR","MSE","MMSE","FullMSE","FullROC","FullTPR","FullFPR","FullFNR","FullPPR","ModelCalibration","ModelNE","ModelRIG"
            , "Nu", "Hours", "LengthScale", "ClusterCount","EqClicks","LearningRate", "MSE")
  data = selectNecessaryColumns(data, columns)
  if(length(files) > 1){
    for (name in files){
      data1 <- read.csv(file=paste0(cur_path, paste0(name, ".csv")), header=TRUE, sep=",")
      data1 = selectNecessaryColumns(data1, columns)
      data <- rbind(data, data1)  
    }
  }
  data$Percent = data$Clicks / data$Impressions * 100
  data$Factor = factor(paste(data$Method, " ", data$Alpha, " R:", data$RecommendationPart * 100, sep=""))
  data$UserPercentage = factor(data$RecommendationPart * 100)
  data$Timestamp = as.POSIXct(data$Timestamp, origin="1970-01-01")
  data
}
  
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

plotGroup <- function(g1, g2, title) {
  mylegend<-g_legend(g2)
  grid.arrange(arrangeGrob(g1 + theme(legend.position="none"),
                           g2 + theme(legend.position="none"),
                                 nrow=1, ncol=2, widths=unit(c(10, 10), "cm"), heights=unit(9, "cm")),
                mylegend, nrow=2, widths=unit(20, "cm"), heights=unit(c(9, 1), "cm"),
                top = title)
}

getCTRPlot <- function(data, limits = c(0,1.5), scaleName="", pos="bottom") {
  g1 = ggplot(data, aes(x=TotalImpressions, y=Percent, colour=Factor)) + 
    geom_line() +
    xlab("Impressions") + ylab("CTR") +
    expand_limits(y=limits) + 
    scale_x_continuous(labels=formatterM()) + 
    scale_y_continuous(labels=formatterPercent()) +
    scale_color_discrete(name=scaleName) +
    theme_bw() +
    theme(plot.title = element_text(size = 10, face = "bold"), 
          legend.title=element_text(size=12), 
          legend.text=element_text(size=8), 
          legend.key.size = unit(1,"line"),
          axis.title.x = element_text(size=8),
          axis.title.y = element_text(size=8),
          legend.position=pos) 
    
  g1
}

getMSEPlot <- function(data, xLimit, scaleName, pos = "bottom") {
  g2 = ggplot(data, aes(x=TotalImpressions, y=MSE, colour=Factor)) + 
  stat_smooth(aes(y=MSE, colour=Factor), method = "lm", formula = y ~ poly(x, 20), se = FALSE) +
    xlab("Impressions") + ylab("MSE") +
    expand_limits(y=xLimit) + 
    scale_x_continuous(labels=formatterM()) +
    theme_bw() +
     theme(plot.title = element_text(size = 10, face = "bold"), 
          legend.title=element_text(size=12), 
          legend.text=element_text(size=8), 
          legend.position=pos,
          legend.key.size = unit(1,"line"),
          axis.title.x = element_text(size=8),
          axis.title.y = element_text(size=8))+
    scale_color_discrete(name=scaleName)
  g2
}
  
```


\section*{\centering {Best performance per algorithm for 20\% recommendation size}}
```{r Best, include=TRUE, echo=FALSE, warning=FALSE}
source("~/Documents/ETH/ASL/ASL_Middleware/analysis/R/External.R")

files =  c("Random")
campaign_id =  837817
path = paste("~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/", campaign_id, "/", sep="")
random = prepData(files, path)
random$CampaignId = campaign_id
for (campaign_id in c(809153, 722100, 597165))
{
  path = paste("~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/", campaign_id, "/", sep="")
  data = prepData(files, path)
  data$CampaignId = campaign_id
  random = rbind(random, data)  
}

group = list(random$CampaignId)
clicks = aggregate(random$Click, by = group, max)
names(clicks) <- c("CampaignId", "Clicks")
impressions = aggregate(random$Impressions, by = group, max)
names(impressions) <- c("CampaignId","Impressions")
groupped = merge(clicks, impressions, by=c("CampaignId"))
groupped$CTR = groupped$Clicks/groupped$Impressions

#files = c("Regression_Test")
files =  c("LinUCB_Disjoint_Metrics", "Random")
campaign_id =  837817
path = paste("~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/", campaign_id, "/", sep="")
all = prepData(files, path)
all$CampaignId = campaign_id
all$BaseCTR = groupped[groupped$CampaignId == campaign_id, "CTR"]
for (campaign_id in c(837817, 722100))
{
  path = paste("~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/", campaign_id, "/", sep="")
  data = prepData(files, path)
  data$CampaignId = campaign_id
  data$BaseCTR = groupped[groupped$CampaignId == campaign_id, "CTR"]
  all = rbind(all, data)  
}

all = subset(all, Impressions > 1000 & ((Alpha == 0.1 & EqClicks == 0.0 & Method == "LinUCB_Disjoint")  | Method == "Random")) 
group = list(all$RecommendationPart, all$CampaignId, all$Method, all$BaseCTR)
clicks = aggregate(all$Click, by = group, max)
names(clicks) <- c("RecommendationPart", "CampaignId", "Method", "BaseCTR", "Clicks")
impressions = aggregate(all$Impressions, by = group, max)
names(impressions) <- c("RecommendationPart", "CampaignId", "Method", "BaseCTR", "Impressions")

groupped = merge(clicks, impressions, by=c("RecommendationPart", "CampaignId", "Method", "BaseCTR"))

groupped$CTR = groupped$Clicks / groupped$Impressions
groupped$Ratio = groupped$CTR/groupped$BaseCTR
groupped$RecommendationPart = groupped$RecommendationPart * 100
tgcZRead <- summarySE2(groupped, 
                       measurevar=c("Ratio"),
                       groupvars=c("RecommendationPart"))

ggplot(tgcZRead, aes(x=factor(RecommendationPart), y=mean, fill=factor(RecommendationPart))) + 
    geom_bar(position=position_dodge(), stat="identity") +
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9)) +
  xlab("% Recommendation Size") +
  ylab("CTR Ratio") +
  ggtitle("Improvement rate") +
  expand_limits(y=0) +
  theme_bw() +
  scale_fill_hue() + 
  theme(legend.justification=c(1,0), legend.position="right")    

```

```{r Best, include=TRUE, echo=FALSE, warning=FALSE}

#files = c("Regression_Test")
files =  c("GP_Clustered", "NN", "LinUCB_Disjoint", "Regression", "Random","TS_Lin")
data = prepData(files)

#files = c("Regression_Test")
data$Factor = factor(data$Method)
data = subset(data, Impressions > 1000 & RecommendationPart == 0.2 )

data = subset(data, (Method == "GP_Clustered" & EqClicks == 0 & ClusterCount == 10 & Hours == 12 & LengthScale == 100 & Nu == 2.5 ) |
                (Method == "NN" & EqClicks == 0.5 & LearningRate == 0.01 ) |
                (Method == "Regression" & EqClicks == 0 & Alpha == 0.01) |
                (Method == "LinUCB_Disjoint" & EqClicks == 0 & Alpha == 0.01)|
                (Method == "TS_Lin" & EqClicks == 0 & Alpha == 0.001)|
                (Method == "Random" ) 
                )

g1 = getCTRPlot(data, c(0,0.75), scaleName = "Alrigithm")  

g2 = getMSEPlot(data, c(0,0.003), "Alrigithms:")

g = plotGroup(g1, g2, "CTR and MSE for Different Algorithms (Recommendation Size: 20%)")
ggsave(paste(imageLocation, paste(campaign_id, "_AllAlgorithms.png", sep="")), plot=g, width = 20, height = 11, units = "cm")
```
\newpage
\section*{\centering Random}
```{r Random, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("Random")
data = prepData(files)
data$Factor = factor(data$Method)

g1 = getCTRPlot(data, c(0,1), "")
g2 = getMSEPlot(data, c(0,1), "")

plotGroup(g1, g2, "Random")
```
\newpage
\section*{\centering GP CTR and modified MSE}
Recommendation for all of the experiements for GP is 20% size.
```{r GP, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("GP_Clustered")
data = prepData(files)
data = subset(data, Impressions > 1000)

data1 = subset(data, Nu == 2.5 & Hours == 12 & LengthScale == 100 & ClusterCount == 10)
data1$Factor = factor(paste(data1$EqClicks, sep = ""))

data2 = subset(data, EqClicks == 0 & Hours == 12 & LengthScale == 100 & ClusterCount == 10)
data2$Factor = factor(paste(data2$Nu, sep = ""))

data3 = subset(data, EqClicks == 0 & Hours == 12 & LengthScale == 100 & Nu == 2.5)
data3$Factor = factor(paste(data3$ClusterCount , sep = ""))

g1 = getCTRPlot(data1, c(0,1), "EQ:")+ ggtitle("EQ - Nu:2.5,H:12,CC:10")
g2 = getCTRPlot(data2, c(0,1), "Nu:")  + ggtitle("Nu - EQ:0,H:12,CC:10")
g3 = getCTRPlot(data3, c(0,1), "CC:")   + ggtitle("CC - EQ:0.2,Nu:2.5,H:12")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"), top="GP results")

```
\break\break
```{r GP_MSE, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("GP_Clustered")
data = prepData(files)
data = subset(data, Impressions > 1000)

data1 = subset(data, Nu == 2.5 & Hours == 12 & LengthScale == 100 & ClusterCount == 10)
data1$Factor = factor(paste(data1$EqClicks, sep = ""))

data2 = subset(data, EqClicks == 0 & Hours == 12 & LengthScale == 100 & ClusterCount == 10)
data2$Factor = factor(paste(data2$Nu, sep = ""))

data3 = subset(data, EqClicks == 0.2 & Hours == 12 & LengthScale == 100 & Nu == 2.5)
data3$Factor = factor(paste(data3$ClusterCount , sep = ""))

g1 = getMSEPlot(data1, c(0,0.01), "EQ:")+ ggtitle("EQ - Nu:2.5,H:12,CC:10")
g2 = getMSEPlot(data2, c(0,0.01), "Nu:")  + ggtitle("Nu - EQ:0,H:12,CC:10")
g3 = getMSEPlot(data3, c(0,0.01), "CC:")   + ggtitle("CC - EQ:0.2,Nu:2.5,H:12")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"), top="GP MMSE results")

```


\newpage
\section*{\centering LinUCB CTR and modified MSE}
```{r LinUCB, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("LinUCB_Disjoint")
data = prepData(files)
data = subset(data, Impressions > 1000)

data_alpha = subset(data, EqClicks == 0.0 & RecommendationPart == 0.02)
data_alpha$Factor = factor(paste(data_alpha$Alpha, sep = ""))

data_rec = subset(data, Alpha == 0.1 & EqClicks == 0.0)
data_rec$Factor = factor(paste(data_rec$RecommendationPart * 100, "%",sep = ""))

data_eq = subset(data, RecommendationPart == 0.02 & Alpha == 0.1)
data_eq$Factor = factor(paste(data_eq$EqClicks*100, "%", sep = ""))

g1 = getCTRPlot(data_alpha, c(0,3), "Alpha:")  + ggtitle("Alpha Change-EQ:0,Rec:0.2")
g2 = getCTRPlot(data_rec, c(0,1), "Rec:")      + ggtitle("Rec. Change-Alpha:0.1")
g3 = getCTRPlot(data_eq, c(0,1), "EQ:")        + ggtitle("EQ Change-Alpha:0.1")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"), top="LinUCB results")

```
\break\break
```{r LinUCB_MSE, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("LinUCB_Disjoint")
data = prepData(files)
data = subset(data, Impressions > 1000)

data_alpha = subset(data, EqClicks == 0.0 & RecommendationPart == 0.02)
data_alpha$Factor = factor(paste(data_alpha$Alpha, sep = ""))

data_rec = subset(data, Alpha == 0.1 & EqClicks == 0.0)
data_rec$Factor = factor(paste(data_rec$RecommendationPart * 100, "%",sep = ""))

data_eq = subset(data, RecommendationPart == 0.02 & Alpha == 0.1)
data_eq$Factor = factor(paste(data_eq$EqClicks*100, "%", sep = ""))

g1 = getMSEPlot(data_alpha, c(0,0.001), "Alpha:")  + ggtitle("Alpha Change-EQ:0,Rec:0.2")
g2 = getMSEPlot(data_rec, c(0,0.001), "Rec:")      + ggtitle("Rec. Change-Alpha:0.1")
g3 = getMSEPlot(data_eq, c(0,0.001), "EQ:")        + ggtitle("EQ Change-Alpha:0.1")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"), top="LinUCB MMSE results")

```

\newpage
\section*{\centering Regression CTR and modified MSE}
```{r Regression, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("Regression")
data = prepData(files)
data = subset(data, Impressions > 1000)

data_alpha = subset(data, EqClicks == 0.0 & RecommendationPart == 0.02)
data_alpha$Factor = factor(paste(data_alpha$Alpha, sep = ""))

data_rec = subset(data, Alpha == 0.1 & EqClicks == 0.0)
data_rec$Factor = factor(paste(data_rec$RecommendationPart * 100, "%",sep = ""))

data_eq = subset(data, RecommendationPart == 0.02 & Alpha == 0.1)
data_eq$Factor = factor(paste(data_eq$EqClicks*100, "%", sep = ""))

g1 = getCTRPlot(data_alpha, c(0,3), "Alpha:")  + ggtitle("Alpha Change-EQ:0,Rec:0.2")
g2 = getCTRPlot(data_rec, c(0,1), "Rec:")      + ggtitle("Rec. Change-Alpha:0.1")
g3 = getCTRPlot(data_eq, c(0,1), "EQ:")        + ggtitle("EQ Change-Alpha:0.1")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"), top="Regression results")

```
\break\break
```{r Regression_MSE, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("Regression")
data = prepData(files)
data = subset(data, Impressions > 1000)

data_alpha = subset(data, EqClicks == 0.0 & RecommendationPart == 0.02)
data_alpha$Factor = factor(paste(data_alpha$Alpha, sep = ""))

data_rec = subset(data, Alpha == 0.1 & EqClicks == 0.0)
data_rec$Factor = factor(paste(data_rec$RecommendationPart * 100, "%",sep = ""))

data_eq = subset(data, RecommendationPart == 0.02 & Alpha == 0.1)
data_eq$Factor = factor(paste(data_eq$EqClicks*100, "%", sep = ""))

g1 = getMSEPlot(data_alpha, c(0,0.001), "Alpha:")  + ggtitle("Alpha Change-EQ:0,Rec:0.2")
g2 = getMSEPlot(data_rec, c(0,0.001), "Rec:")      + ggtitle("Rec. Change-Alpha:0.1")
g3 = getMSEPlot(data_eq, c(0,0.001), "EQ:")        + ggtitle("EQ Change-Alpha:0.1")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"), top="Regression MMSE results")

```

\newpage
\section*{\centering NN CTR and modified MSE}
```{r NN, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("NN")
data = prepData(files)
data = subset(data, Impressions > 1000)

data1 = subset(data, EqClicks == 0.2 & LearningRate == 0.01)
data1$Factor = factor(paste(data1$RecommendationPart * 100, "%", sep = ""))

data2 = subset(data, EqClicks == 0.2 & RecommendationPart == 0.2)
data2$Factor = factor(paste(data2$LearningRate, sep = ""))

data3 = subset(data, EqClicks == 0.5 & RecommendationPart == 0.2)
data3$Factor = factor(paste(data3$LearningRate, sep = ""))

g1 = getCTRPlot(data1, c(0,1), "Rec:")  + ggtitle("Rec Change-EQ:0.2")
g2 = getCTRPlot(data2, c(0,1), "LRate:")+ ggtitle("LRate Change")
g3 = getCTRPlot(data3, c(0,1), "LRate:")+ ggtitle("LRate Change-EQ:0.5")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"), top="NN results")

```
\newpage
\section*{\centering TS Lin CTR and modified MSE}
```{r TS_Lin, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("TS_Lin")
data = prepData(files)
data = subset(data, Impressions > 1000)

data_alpha = subset(data, EqClicks == 0.0 & RecommendationPart == 0.02)
data_alpha$Factor = factor(paste(data_alpha$Alpha, sep = ""))

data_rec = subset(data, Alpha == 0.001 & EqClicks == 0.0)
data_rec$Factor = factor(paste(data_rec$RecommendationPart * 100, "%",sep = ""))

data_eq = subset(data, RecommendationPart == 0.02 & Alpha == 0.001)
data_eq$Factor = factor(paste(data_eq$EqClicks*100, "%", sep = ""))

g1 = getCTRPlot(data_alpha, c(0,3), "Alpha:")  + ggtitle("Alpha Change-EQ:0,Rec:0.2")
g2 = getCTRPlot(data_rec, c(0,3), "Rec:")      + ggtitle("Rec. Change-Alpha:0.001")
g3 = getCTRPlot(data_eq, c(0,3), "EQ:")        + ggtitle("EQ Change-Alpha:0.001")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"), top="TS_Lin results")

```
\break\break
```{r TS_Lin_MSE, include=TRUE, echo=FALSE, fig.width = 10, fig.asp = 1}

files =  c("TS_Lin")
data = prepData(files)
data = subset(data, Impressions > 1000)

data_alpha = subset(data, EqClicks == 0.0 & RecommendationPart == 0.02)
data_alpha$Factor = factor(paste(data_alpha$Alpha, sep = ""))

data_rec = subset(data, Alpha == 0.001 & EqClicks == 0.0)
data_rec$Factor = factor(paste(data_rec$RecommendationPart * 100, "%",sep = ""))

data_eq = subset(data, RecommendationPart == 0.02 & Alpha == 0.001)
data_eq$Factor = factor(paste(data_eq$EqClicks*100, "%", sep = ""))

g1 = getMSEPlot(data_alpha, c(0,0.001), "Alpha:")  + ggtitle("Alpha Change-EQ:0,Rec:0.2")
g2 = getMSEPlot(data_rec, c(0,0.001), "Rec:")      + ggtitle("Rec. Change-Alpha:0.1")
g3 = getMSEPlot(data_eq, c(0,0.001), "EQ:")        + ggtitle("EQ Change-Alpha:0.1")
grid.arrange(g1, g2, g3, nrow=1, ncol=3, widths=unit(c(6.2, 6.2, 6.2), "cm"), heights=unit(8, "cm"), top="TS_Lin MMSE results")

```

```{r all, include=TRUE, echo=FALSE}

files =  c("TS_Lin", "NN", "LinUCB_Disjoint", "Regression", "GP_Clustered")
data = prepData(files)
data$Factor = factor(data$Method)

data = subset(data, Impressions > 1000 & RecommendationPart == 0.2 )
data = subset(data, 
                (Method == "GP_Clustered" & EqClicks == 0 & ClusterCount == 10 & Hours == 12 & LengthScale == 100 & Nu == 2.5 ) |
                (Method == "NN" & EqClicks == 0.5 & LearningRate == 0.01 ) |
                (Method == "Regression" & EqClicks == 0 & Alpha == 0.01) |
                (Method == "LinUCB_Disjoint" & EqClicks == 0 & Alpha == 0.01)|
                (Method == "TS_Lin" & EqClicks == 0 & Alpha == 0.001)|
                (Method == "Random" ) 
                )

ggplot(data, aes(x=Timestamp, y=Impressions, colour=Factor)) + 
    geom_line() +
    xlab("Timestamp") + ylab("Cumulative Common Impressions") +
    scale_y_continuous(labels=formatterM()) +
    theme_bw() +
    ggtitle("Cumulative # Impressions during Exploration Scavanging")
  
``` 