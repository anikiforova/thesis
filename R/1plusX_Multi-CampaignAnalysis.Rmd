---
title: "Multi-Campaign Analysis"
output: pdf_document
---


```{r include=TRUE, echo=FALSE,warning=FALSE}
library(ggplot2)
library(gridExtra)
source("~/Documents/ETH/ASL/ASL_Middleware/analysis/R/External.R")
source("~/Documents/ETH/Thesis/1plusX/Data/thesis/R/ManageCampaignsLib.R")

imageLocation = "~/Documents/ETH/Thesis/1plusX/Data/thesis/1plusx/Results/Images/Multi-Campaign/"

#simulated_path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Multi-Campaign/Processed/all_simulated_impressions.csv"
```

```{r include=TRUE, echo=FALSE, warning=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Campaigns/5/Processed/all_impressions_agg.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$Timestamp = data$Timestamp / 1000
data$Timestamp = as.POSIXct(data$Timestamp, origin="1970-01-01")

g = ggplot(data, aes(fill=factor(CampaignId), y=Impressions, x=Timestamp)) +
  geom_bar( stat="identity") +
  theme_bw() +
  scale_fill_discrete(name="CampaignId") +
  scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        legend.justification=c(1,0), 
        legend.title=element_text(size=12), 
        legend.text=element_text(size=8), 
        legend.key.size = unit(1,"line"),
        plot.title = element_text(size = 14, face = "bold"), 
        axis.title.y = element_text(size=10)) +
  ggtitle("Impressions per Campaign")

ggsave(paste(imageLocation, "ImpressionsPerCampaign.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g

```


```{r include=TRUE, echo=FALSE, warning=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Campaigns/5/Processed/all_impressions_agg.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$Timestamp = data$Timestamp / 1000
data$Timestamp = as.POSIXct(data$Timestamp, origin="1970-01-01")
g = ggplot(data, aes(color=factor(CampaignId), y=CTR, x=Timestamp)) +
  #geom_bar( stat="identity") +
  #stat_smooth(aes(color=factor(CampaignId), y=CTR, x=Timestamp), method = "lm", formula = y ~ poly(x, 20), se = FALSE, size=2) +
  geom_line()+
  scale_color_discrete(name="CampaignId") +
  theme_bw() +
  scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        legend.justification=c(1,0), 
        legend.title=element_text(size=12), 
        legend.text=element_text(size=8), 
        legend.key.size = unit(1,"line"),
        plot.title = element_text(size = 14, face = "bold"), 
        axis.title.y = element_text(size=10)) +
  ggtitle("CTR per Campaign")

ggsave(paste(imageLocation, "CTRPerCampaign.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g
```



```{r Best, include=TRUE, echo=FALSE, warning=FALSE}

columnNames = c("CampaignId", "Method", "RecommendationPart", "CTR", "Clicks", "Impressions", "FullFNR", "FullTPR", "BaseCTR", "Ratio")
all = data.frame(matrix(vector(), 0, length(columnNames), dimnames=list(c(), columnNames)), stringsAsFactors=F)
campaignIds = c(866128, 856805, 847460, 858140, 865041)
alphas = c(0.1, 0.01, 0.1, 0.1, 0.1)
index = 1
for (campaignId in campaignIds)
{
  random = getCampaignMetrics(files =  c("Random_Metrics"),  campaignId = campaignId, baseCTR=0, method="Random", alpha = 0)
  data = getCampaignMetrics(files = c("LinUCB_Disjoint_Metrics"), campaignId = campaignId, baseCTR=random[1, "CTR"], method="LinUCB_Disjoint", alpha = alphas[index]) 
  
  data$RecommendationPartGainsRatio = data$FullTPR * 100 / data$RecommendationPart
  all = rbind(all, data) 
  index = index + 1  
}

ratioData <- summarySE2(all, measurevar=c("Ratio"), groupvars=c("CampaignId"))
fprData <- summarySE2(all, measurevar=c("RecommendationPartGainsRatio"), groupvars=c("CampaignId"))

ratioData$CampaignId = factor(ratioData$CampaignId)
fprData$CampaignId = factor(fprData$CampaignId)
g1 = getBarPlotCampaigns(ratioData, yLabel = "Cumulative CTR Ratio", title="")
g2 = getBarPlotCampaigns(fprData, yLabel = "TPR Ratio", title="")

width = 8
g = plotGroupNoLegend(g1, g2, "CTR and TPR Ratio for Campaigns from Multi-Campaign List", width) 
ggsave(paste(imageLocation, "CTRRationPerCampaign.png", sep=""), plot=g, width = width * 2, height = 11, units = "cm")
g
```

```{r Best, include=TRUE, echo=FALSE, warning=FALSE}

columnNames = c("CampaignId", "Timestamp", "BatchCTR")
all = data.frame(matrix(vector(), 0, length(columnNames), dimnames=list(c(), columnNames)), stringsAsFactors=F)
campaignIds = c(866128, 856805, 847460, 858140, 865041)
alphas = c(0.1, 0.01, 0.1, 0.1, 0.1)
index = 1
for (campaignId in campaignIds)
{
  path = paste("~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/", campaignId, "/", sep="")
  data = prepData(files, path)
  data = subset(data, Impressions > 1000 & RecommendationPart == 0.2 & Alpha == alphas[index] )
  data$CampaignId = campaignId
  all = rbind(all, data[columnNames]) 
}

all$Timestamp = as.numeric(all$Timestamp) / 1000
all$Timestamp = as.POSIXct(all$Timestamp, origin="1970-01-01")
g = ggplot(all, aes(color=factor(CampaignId), y=BatchCTR, x=Timestamp)) +
  geom_line()+
  scale_color_discrete(name="CampaignId") +
  theme_bw() +
  scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        legend.justification=c(1,0), 
        legend.title=element_text(size=12), 
        legend.text=element_text(size=8), 
        legend.key.size = unit(1,"line"),
        plot.title = element_text(size = 14, face = "bold"), 
        axis.title.y = element_text(size=10)) +
  ggtitle("Batch CTR per Campaign")

ggsave(paste(imageLocation, "BatchCTRPerCampaign.png", sep=""), plot=g, width = 16, height = 11, units = "cm")
g
```
For each campaign there are users that observed only that campaign and ones that are shared beween multiple campaigns. 
Below is the breakdown of the percentage of users per campaign that have seen only that campaign.


```{r include=TRUE, echo=FALSE, warning=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Campaigns/5/Processed/MultiCampaignStats.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$PercentUniqueUsers = (data$NonJoinedUserCount / data$TotalDistinctUserCount) * 100
data$Date = as.POSIXct(as.Date(data$Date))
g = ggplot(data, aes(color=factor(CampaignId), y=PercentUniqueUsers, x=Date)) +
  #geom_bar( stat="identity") +
  #stat_smooth( aes(color=factor(CampaignId), y=PercentUniqueUsers, x=Date), method = "lm", formula = y ~ poly(x, 20), se = FALSE, size=2) +
  geom_line()+
  scale_color_discrete(name="CampaignId") +
  theme_bw() +
  ylab("User Percent") +
  scale_y_continuous(labels=formatterPercent()) + 
  scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        legend.justification=c(1,0), 
        legend.title=element_text(size=12), 
        legend.text=element_text(size=8), 
        legend.key.size = unit(1,"line"),
        plot.title = element_text(size = 14, face = "bold"), 
        axis.title.y = element_text(size=10)) +
  ggtitle("Percentage of Users Uniquely Seen by Campaign per Day")

ggsave(paste(imageLocation, "UniqueUsersPerCampaign.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g
```

A breakdown of users per how many campaigns per day have they seen.
Majority of the users have seen a single unique campaign per day.


```{r include=TRUE, echo=FALSE, warning=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Campaigns/5/Processed/MultiCampaignUserStats.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$Date = as.POSIXct(as.Date(data$Date))

g = ggplot(data, aes(fill=factor(CampaignCount), y=UserCount, x=Date)) +
  geom_bar( stat="identity") +
  theme_bw() +
  ylab("User Count") +
  scale_y_continuous(labels=formatterK()) + 
  scale_fill_discrete(name="# Observed Campaigns") +
  scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        legend.justification=c(1,0), 
        legend.title=element_text(size=12), 
        legend.text=element_text(size=8), 
        legend.key.size = unit(1,"line"),
        plot.title = element_text(size = 14, face = "bold"), 
        axis.title.y = element_text(size=10)) +
  ggtitle("% Users grouped by # Observed Campaigns")

ggsave(paste(imageLocation, "UsersGroupsPerCampaign.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g

```


The question to answer with the following two graphicsis: Can we identify "click users"?  


```{r include=TRUE, echo=FALSE, warning=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Campaigns/5/Processed/MultiCampaignClickStats.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$Date = as.POSIXct(as.Date(data$Date))

#data = subset(data, CampaignCount != 1)
summary <- summarySE2(data, measurevar=c("UserCount"), groupvars=c("CampaignCount", "ClickedCampaignsCount"))
summary$Factor = factor(paste(summary$ClickedCampaignsCount, "/", summary$CampaignCount, sep=""))

g = ggplot(summary, aes(x=Factor, y=mean, fill=Factor)) + 
    geom_bar(position=position_dodge(), stat="identity") +
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, position=position_dodge(.9)) +
    ylab("# Users") + xlab("(# Clicked Campaigns) / (# Seen Campaigns)") + ggtitle("Daily Click Users: (# Clicked Campaigns) / (# Seen Campaigns)") +
    theme_bw() +
    scale_fill_hue() + 
    theme(legend.justification=c(1,0), 
          legend.position="none",
          legend.title=element_text(size=12), 
          legend.text=element_text(size=8), 
          legend.key.size = unit(1,"line"),
          plot.title = element_text(size = 14, face = "bold"), 
          axis.title.x = element_text(size=10),
          axis.title.y = element_text(size=10)) 
 
ggsave(paste(imageLocation, "ClickersPerCampaignSeen.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g

```


```{r include=TRUE, echo=FALSE, warning=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Campaigns/5/Processed/MultiCampaignUserClickStats.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$Date = as.POSIXct(as.Date(data$Date))

g = ggplot(data, aes(fill=factor(CampaignCount), y=ClickUserCount, x=Date)) +
  geom_bar( stat="identity") +
  theme_bw() +
  ylab("User Count") +
  scale_y_continuous(labels=formatterK()) + 
  scale_fill_discrete(name="# Clicked Campaigns") +
  scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        legend.justification=c(1,0), 
        legend.title=element_text(size=12), 
        legend.text=element_text(size=8), 
        legend.key.size = unit(1,"line"),
        plot.title = element_text(size = 14, face = "bold"), 
        axis.title.y = element_text(size=10)) +
  ggtitle("# Click Users grouped by # Campaigns they have clicked on")

ggsave(paste(imageLocation, "ClickersPerCampaignCount.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g

```

```{r include=True, echo=FALSE, warning=FALSE}
columnNames = c("CampaignId", "Method", "RecommendationPart", "CTR", "Clicks", "Impressions", "FullFNR", "FullTPR", "BaseCTR", "Ratio", "Timestamp")
all = data.frame(matrix(vector(), 0, length(columnNames), dimnames=list(c(), columnNames)), stringsAsFactors=F)
campaignIds = c(866128, 856805, 847460, 858140, 865041)
for (campaignId in campaignIds)
{
  random = getCampaignMetrics(files =  c("Random_Metrics"),  campaignId = campaignId, baseCTR=0, method="Random")
  data = getCampaignMetrics(files = c("LinUCB_Disjoint_Metrics"), campaignId = campaignId, baseCTR=random[1, "CTR"], method="LinUCB_Disjoint", alpha = 0.1) 
  data$RecommendationPartGainsRatio = data$FullTPR * 100 / data$RecommendationPart
  all = rbind(all, data) 
}
all$Timestamp = as.numeric(all$Timestamp) / 1000
all$Date = (as.integer(all$Timestamp / (24*3600))) * (24*3600)
all$Date = as.POSIXct(all$Date, origin="1970-01-01")

clicks = sum(all$Clicks)
impressions = sum(all$Impressions)
CTR = clicks/ impressions
# 0.004783994 - for the first 6 days (till 20th)
# 0.003313168 - for the entire duration
cat (paste("Achieved CTR when training each one of the campaigns separately: ", CTR, sep=""))

files =  c("Random_Metrics", "LinUCB_Disjoint_Metrics") # , "LinUCB_Disjoint_Multi_Metrics"
path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/5/"
data = prepData(files, path)

data$Factor = factor(paste(data$Method, " A:", data$Alpha, sep=""))
#data$Percent = data$BatchCTR * 100
g1 = getCTRPlot(data, c(0,0.6)) + 
  geom_hline(yintercept = CTR * 100) +
  ggtitle("Learn Combined Campaign Data (Hindsight CTR - Learn Each Campaign Individually)")

g1
```

```{r include=True, echo=FALSE, warning=FALSE}

path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/5/"
files =  c("LinUCB_Disjoint_Multi_Metrics", "LinUCB_Disjoint_Metrics", "Random_Metrics", "LinUCB_Disjoint_Multi_Mix_Metrics")
data = prepData(files, path)

data = subset(data, Alpha == 0  | 
                (Alpha == 0.1   
              & (data$TargetSplit == "DAILY" | is.na(data$TargetSplit))
              & (data$TargetAlpha == 1 | is.na(data$TargetAlpha))
              & (data$TargetPercent == 1 | is.na(data$TargetPercent))
              ))

data$Factor = factor(paste(data$Method, data$Alpha))
#data$Percent = data$BatchCTR * 100
g1 = getCTRPlot(data, c(0,0.6)) 
#data = subset(data, Method != "Random")
#g2 = getMSEPlot(data, c(0,0.003), "Algorithms:")
 g2 = ggplot(data, aes(x=TotalImpressions, y=FullTPR, colour=Factor)) + 
    stat_smooth(aes(y=FullTPR, colour=Factor), method = "lm", formula = y ~ poly(x, 20), se = FALSE, size=1) +
    xlab("Impressions") + ylab("TPR") +
    #expand_limits(y=xLimit) + 
    scale_x_continuous(labels=formatterM()) +
    theme_bw() +
    theme(plot.title = element_text(size = 10, face = "bold"), 
          legend.title=element_text(size=12), 
          legend.text=element_text(size=8), 
          legend.key.size = unit(1,"line"),
          legend.position="bottom",
          axis.title.x = element_text(size=8),
          axis.title.y = element_text(size=8))+
    scale_color_discrete(name="Algos:")
 
# g1
plotGroup(g1, g2, "Multi-Campaign vs Single-Campaign (20%) handling") 

```

```{r include=True, echo=FALSE, warning=FALSE}

path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/5/"
files =  c("LinUCB_Disjoint_Multi_Metrics", "LinUCB_Disjoint_Multi_Target_Metrics", "Random_Multi_Metrics")
data = prepData(files, path)

data = subset(data, Alpha == 0  | 
                (Alpha == 0.1
              & (data$TargetSplit == "NO_SPLIT" | is.na(data$TargetSplit))
              & (data$TargetAlpha == 1 | is.na(data$TargetAlpha))
              & (data$TargetPercent == 1 | is.na(data$TargetPercent))
              ))

data$Factor = factor(data$Method)
g1 = getCTRPlot(data, c(0,0.6)) 
data$Percent = data$BatchCTR * 100
g2 = getCTRPlot(data, c(0,0.6)) 
plotGroup(g1, g2, "Target vs \"Pure\" Multi-Campaigns") 

```

```{r include=True, echo=FALSE, warning=FALSE}

log_path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Log/5/"
files =  c("LinUCB_Disjoint_Multi_Target_Metrics")
data <- read.csv(file=paste0(log_path, paste0(files[1], ".csv")), header=TRUE, sep=",")

data = subset(data, Type == "Total" & Alpha == 0.1 & TargetPercent == 1 & TargetSplit == "NO_SPLIT" & TargetAlpha == 1)
data$dX847460 <- ave(data$X847460, data$Type, FUN=function(x) c(0, diff(x)))
data$dX856805 <- ave(data$X856805, data$Type, FUN=function(x) c(0, diff(x)))
data$dX866128 <- ave(data$X866128, data$Type, FUN=function(x) c(0, diff(x)))
data$dX865041 <- ave(data$X865041, data$Type, FUN=function(x) c(0, diff(x)))
data$dX858140 <- ave(data$X858140, data$Type, FUN=function(x) c(0, diff(x)))

data = subset(data, !( dX856805 == 0 & dX847460 == 0 &  dX866128 == 0 & dX865041 == 0 & dX858140 == 0))
data





```

```{r include=True, echo=FALSE, warning=FALSE}

path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/5/"
files =  c( "LinUCB_Disjoint_Multi_Target_Metrics", "TS_Lin_Multi_Target_Metrics", "Random_Multi_Metrics")
data = prepData(files, path)

data = subset(data, Alpha == 0  | 
                (((Alpha == 0.1 & Method != "TS_Lin_Multi_Target") | (Alpha == 0.001 & Method == "TS_Lin_Multi_Target"))
              & (data$TargetSplit == "NO_SPLIT" | is.na(data$TargetSplit))
              & (data$TargetAlpha == 1 | is.na(data$TargetAlpha))
              & (data$TargetPercent == 1 | is.na(data$TargetPercent))
              ))

data$Factor = factor(data$Method)
g1 = getCTRPlot(data, c(0,0.6)) 
data$Percent = data$BatchCTR * 100
g2 = getCTRPlot(data, c(0,0.6)) 
plotGroup(g1, g2, "Target Algorithm Comparison") 

```

```{r include=True, echo=FALSE, warning=FALSE}

path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Log/5/Campaign_Log.csv"
all <- read.csv(file=path)
limit = 1
data = subset(all, Method == "Random")
data$Ratio = data$Impressions / sum(data$Impressions)
p1 = getCampaignComparisonPlot(data, "Impression Ratio", "Random", limit) 

data = subset(all, Method == "LinUCB_Disjoint")
data$Ratio = data$Impressions / sum(data$Impressions)
p2 = getCampaignComparisonPlot(data, "Impression Ratio", "LinUCB Single Campaign", limit) 

data = subset(all, Method == "LinUCB_Disjoint_Multi_Mix" & Alpha == 0.0001)
data$Ratio = data$Impressions / sum(data$Impressions)
p3 = getCampaignComparisonPlot(data, "Impression Ratio", "LinUCB Multi-Campaign", limit) 

mylegend<-g_legend(p1)
plot_count = 3
p5 = grid.arrange(arrangeGrob(p1 + theme(legend.position="none"),
                               p2 + theme(legend.position="none"),
                               p3 + theme(legend.position="none"),
                               #p4 + theme(legend.position="none"),
                               nrow=1, ncol=plot_count, widths=unit(rep(9, plot_count),"cm"), heights=unit(12, "cm")),
                   mylegend, nrow=2, widths=unit(plot_count * 9, "cm"), heights=unit(c(12, 1), "cm"),
                  top = textGrob("20% Recommendation Impression Ratio Performance", gp=gpar(fontsize=15,fontface=2)))

ggsave(paste(imageLocation, "S_VS_Multi_ImpressionRatioPerCampaign.png", sep=""), plot=p5, width = 36, height = 14, units = "cm")
```
```{r include=True, echo=FALSE, warning=FALSE}

path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Log/5/Campaign_Log.csv"
all <- read.csv(file=path)
limit = 1
data = subset(all, Method == "Random")
data$Ratio = data$Clicks / sum(data$Clicks)
p1 = getCampaignComparisonPlot(data, "Click Ratio", "Random", limit) 

data = subset(all, Method == "LinUCB_Disjoint")
data$Ratio = data$Clicks / sum(data$Clicks)
p2 = getCampaignComparisonPlot(data, "Click Ratio", "LinUCB Single Campaign", limit) 

data = subset(all, Method == "LinUCB_Disjoint_Multi_Mix" & Alpha == 0.0001)
data$Ratio = data$Clicks / sum(data$Clicks)
p3 = getCampaignComparisonPlot(data, "Click Ratio", "LinUCB Multi-Campaign", limit) 

mylegend<-g_legend(p1)
plot_count = 3
p5 = grid.arrange(arrangeGrob(p1 + theme(legend.position="none"),
                               p2 + theme(legend.position="none"),
                               p3 + theme(legend.position="none"),
                               #p4 + theme(legend.position="none"),
                               nrow=1, ncol=plot_count, widths=unit(rep(9, plot_count),"cm"), heights=unit(12, "cm")),
                   mylegend, nrow=2, widths=unit(plot_count * 9, "cm"), heights=unit(c(12, 1), "cm"),
                  top = textGrob("20% Recommendation Click Ratio Performance", gp=gpar(fontsize=15,fontface=2)))

#p5
ggsave(paste(imageLocation, "S_VS_Multi_ClicksRatioPerCampaign.png", sep=""), plot=p5, width = 36, height = 16, units = "cm")

```

```{r include=True, echo=FALSE, warning=FALSE}

path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Log/5/Campaign_Log.csv"
all <- read.csv(file=path)
all$Impressions = as.integer(all$Impressions)
limit = 1
data = subset(all, Method == "Random_Multi")

data$Ratio = data$Impressions / sum(data$Impressions)
p1 = getCampaignComparisonPlot(data, "Impression Ratio", "Random", limit) 

data = subset(all, Method == "LinUCB_Disjoint_Multi" & Alpha == 0.1)
data$Ratio = data$Impressions / sum(data$Impressions)
p2 = getCampaignComparisonPlot(data, "Impression Ratio", "LinUCB Multi-Campaign", limit) 

data = subset(all, Method == "LinUCB_Disjoint_Multi_Target" & Alpha == 0.1 & RecommendationPart == "NO_SPLIT_1_False")
data$Ratio = data$Impressions / sum(data$Impressions)
p3 = getCampaignComparisonPlot(data, "Impression Ratio", "LinUCB Targeted Multi-Campaign", limit) 

mylegend<-g_legend(p3)
plot_count = 3
p5 = grid.arrange(arrangeGrob(p1 + theme(legend.position="none"),
                               p2 + theme(legend.position="none"),
                               p3 + theme(legend.position="none"),
                               #p4 + theme(legend.position="none"),
                               nrow=1, ncol=plot_count, widths=unit(rep(9, plot_count),"cm"), heights=unit(12, "cm")),
                   mylegend, nrow=2, widths=unit(plot_count * 9, "cm"), heights=unit(c(12, 1), "cm"),
                  top = textGrob("Multi-Campaign Impression Ratio Performance", gp=gpar(fontsize=15,fontface=2)))

ggsave(paste(imageLocation, "Multi_VS_Target_ImpressionRatioPerCampaign.png", sep=""), plot=p5, width = 36, height = 14, units = "cm")
```

```{r include=True, echo=FALSE, warning=FALSE}

path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Log/5/Campaign_Log.csv"
all <- read.csv(file=path)
limit = 1
data = subset(all, Method == "Random_Multi")
data$Ratio = data$Clicks / sum(data$Clicks)
p1 = getCampaignComparisonPlot(data, "Click Ratio", "Random", limit) 

data = subset(all, Method == "LinUCB_Disjoint_Multi" & Alpha == 0.1)
data$Ratio = data$Clicks / sum(data$Clicks)
p2 = getCampaignComparisonPlot(data, "Click Ratio", "LinUCB Multi-Campaign", limit) 

data = subset(all, Method == "LinUCB_Disjoint_Multi_Target" & Alpha == 0.1 & RecommendationPart == "NO_SPLIT_1_False")
data$Ratio = data$Clicks / sum(data$Clicks)
p3 = getCampaignComparisonPlot(data, "Click Ratio", "LinUCB Target Multi-Campaign", limit) 

mylegend<-g_legend(p3)
plot_count = 3
p5 = grid.arrange(arrangeGrob(p1 + theme(legend.position="none"),
                               p2 + theme(legend.position="none"),
                               p3 + theme(legend.position="none"),
                               #p4 + theme(legend.position="none"),
                               nrow=1, ncol=plot_count, widths=unit(rep(9, plot_count),"cm"), heights=unit(12, "cm")),
                   mylegend, nrow=2, widths=unit(plot_count * 9, "cm"), heights=unit(c(12, 1), "cm"),
                  top = textGrob("Multi-Campaign Click Ratio Performance", gp=gpar(fontsize=15,fontface=2)))

#p5
ggsave(paste(imageLocation, "Multi_VS_Target_ClickRatioPerCampaign.png", sep=""), plot=p5, width = 36, height = 16, units = "cm")

```
```{r include=True, echo=FALSE, warning=FALSE}

path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Log/5/Campaign_Log.csv"
all <- read.csv(file=path)
limit = 0.003
data = subset(all, Method == "Random_Multi")
data$Ratio = data$Clicks / data$Impressions
p1 = getCampaignComparisonPlot(data, "CTR", "Random", limit) 

data = subset(all, Method == "LinUCB_Disjoint_Multi" & Alpha == 0.1)
data$Ratio = data$Clicks / data$Impressions
p2 = getCampaignComparisonPlot(data, "CTR", "LinUCB Multi-Campaign", limit) 

data = subset(all, Method == "LinUCB_Disjoint_Multi_Target" & Alpha == 0.1 & RecommendationPart == "NO_SPLIT_1_False")
data$Ratio = data$Clicks / data$Impressions
p3 = getCampaignComparisonPlot(data, "CTR", "LinUCB Target Multi-Campaign", limit) 

mylegend<-g_legend(p3)
plot_count = 3
p5 = grid.arrange(arrangeGrob(p1 + theme(legend.position="none"),
                               p2 + theme(legend.position="none"),
                               p3 + theme(legend.position="none"),
                               #p4 + theme(legend.position="none"),
                               nrow=1, ncol=plot_count, widths=unit(rep(9, plot_count),"cm"), heights=unit(12, "cm")),
                   mylegend, nrow=2, widths=unit(plot_count * 9, "cm"), heights=unit(c(12, 1), "cm"),
                  top = textGrob("Multi-Campaign CTR Performance", gp=gpar(fontsize=15,fontface=2)))

#p5
ggsave(paste(imageLocation, "Multi_VS_Target_CTRPerCampaign.png", sep=""), plot=p5, width = 36, height = 16, units = "cm")

```

```{r include=True, echo=FALSE, warning=FALSE}

path = "~/Documents/ETH/Thesis/1plusX/Data/Thesis/1plusx/Results/5/"
#files =  c("LinUCB_Disjoint_Multi_Target", "Random_Metrics", "LinUCB_Disjoint_Multi_Metrics")
files =  c("Random_Metrics", "LinUCB_Disjoint_Multi_Target")
data = prepData(files, path)

#data = subset(data, Method %in% c("Random", "LinUCB_Disjoint_Multi_Target") | 
 #              (Alpha == 0.1 & Method == "LinUCB_Disjoint_Multi"))

data$Factor = factor(paste(data$Method, data$Alpha, data$TargetSplit, data$EarlyUpdate))
#data = subset(data, data$TargetSplit == "DAILY")
data$Percent = data$BatchCTR * 100
g1 = getCTRPlot(data, c(0,0.6)) 
data = subset(data, Method == "LinUCB_Disjoint_Multi_Target")
#g2 = getMSEPlot(data, c(0,0.003), "Algorithms:")
g2 = ggplot(data, aes(x=TotalImpressions, y=BatchMSE, colour=Factor)) + 
  geom_line() + 
#  stat_smooth(aes(y=FullTPR, colour=Factor), method = "lm", formula = y ~ poly(x, 20), se = FALSE, size=1) +
    xlab("Impressions") + ylab("Full MSE") +
    #expand_limits(y=xLimit) + 
    scale_x_continuous(labels=formatterM()) +
    theme_bw() +
    theme(plot.title = element_text(size = 10, face = "bold"), 
          legend.title=element_text(size=12), 
          legend.text=element_text(size=8), 
          legend.key.size = unit(1,"line"),
          legend.position="bottom",
          axis.title.x = element_text(size=8),
          axis.title.y = element_text(size=8))+
    scale_color_discrete(name="Algos:")
plotGroup(g1, g2, "Multi-Campaign vs Single-Campaign (20%) handling") 

```