---
title: "R Notebook"
output: pdf_document
---


```{r include=TRUE, echo=FALSE,warning=FALSE}
library(ggplot2)
library(gridExtra)
source("~/Documents/ETH/ASL/ASL_Middleware/analysis/R/External.R")

imageLocation = "~/Documents/ETH/Thesis/1plusX/Data/thesis/1plusx/Results/Images/Multi-Campaign/"

#simulated_path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Multi-Campaign/Processed/all_simulated_impressions.csv"
```

```{r include=TRUE, echo=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Multi-Campaign/Processed/5_all_impressions_agg.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$Timestamp = data$Timestamp / 1000
data$Timestamp = as.POSIXct(data$Timestamp, origin="1970-01-01")

g = ggplot(data, aes(fill=factor(CampaignId), y=Impressions, x=Timestamp)) +
  geom_bar( stat="identity") +
  theme_bw() +
  scale_fill_discrete(name="CampaignId") +
  scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        axis.title.x=element_blank()) +
  ggtitle("Impressions per Campaign")

ggsave(paste(imageLocation, "ImpressionsPerCampaign.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g

```

```{r include=TRUE, echo=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Multi-Campaign/Processed/5_all_impressions_agg.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$Timestamp = data$Timestamp / 1000
data$Timestamp = as.POSIXct(data$Timestamp, origin="1970-01-01")
g = ggplot(data, aes(color=factor(CampaignId), y=CTR, x=Timestamp)) +
  #geom_bar( stat="identity") +
  stat_smooth(aes(color=factor(CampaignId), y=CTR, x=Timestamp), method = "lm", formula = y ~ poly(x, 20), se = FALSE, size=2) +
  #geom_line()+
  scale_color_discrete(name="CampaignId") +
  theme_bw() +
  scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        axis.title.x=element_blank()) +
  ggtitle("CTR per Campaign")

ggsave(paste(imageLocation, "CTRPerCampaign.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g
```
```{r Best, include=TRUE, echo=FALSE, warning=FALSE}

columnNames = c("CampaignId", "Method", "RecommendationPart", "CTR", "Clicks", "Impressions", "FullFNR", "FullTPR", "BaseCTR", "Ratio")
all = data.frame(matrix(vector(), 0, length(columnNames), dimnames=list(c(), columnNames)), stringsAsFactors=F)
campaignIds = c(866128, 856805, 847460, 858140, 865041)
alphas = c(0.1, 0.01, 0.1, 0.1, 0.1)
index = 1
for (campaignId in campaignIds)
{
  random = getCampaignMetrics(files =  c("Random_Metrics"),  campaignId = campaignId, baseCTR=0, method="Random", alpha = 0)
  data = getCampaignMetrics(files = c("LinUCB_Disjoint_Metrics"), campaignId = campaignId, baseCTR=random[1, "CTR"], method="LinUCB_Disjoint", alpha = alphas[index]) 
  
  data$RecommendationPartGainsRatio = data$FullTPR * 100 / data$RecommendationPart
  all = rbind(all, data) 
  index = index + 1  
}

ratioData <- summarySE2(all, measurevar=c("Ratio"), groupvars=c("CampaignId"))
fprData <- summarySE2(all, measurevar=c("RecommendationPartGainsRatio"), groupvars=c("CampaignId"))

ratioData$CampaignId = factor(ratioData$CampaignId)
fprData$CampaignId = factor(fprData$CampaignId)
g1 = getBarPlotCampaigns(ratioData, yLabel = "CTR Ratio", title="")
g2 = getBarPlotCampaigns(fprData, yLabel = "TPR Ratio", title="")

g = plotGroupNoLegend(g1, g2, "CTR and TPR Ratio for Campaigns Used in Multi-Campaign Experiment") 
ggsave(paste(imageLocation, "CTRRationPerCampaign.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g
```
```{r include=TRUE, echo=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Multi-Campaign/Processed/MultiCampaignStats.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$PercentUniqueUsers = (data$NonJoinedUserCount / data$TotalDistinctUserCount) * 100
data$Date = as.Date(data$Date)
g = ggplot(data, aes(color=factor(CampaignId), y=PercentUniqueUsers, x=Date)) +
  #geom_bar( stat="identity") +
  #stat_smooth( aes(color=factor(CampaignId), y=PercentUniqueUsers, x=Date), method = "lm", formula = y ~ poly(x, 20), se = FALSE, size=2) +
  geom_line()+
  scale_color_discrete(name="CampaignId") +
  theme_bw() +
  ylab("User Percent") +
  scale_y_continuous(labels=formatterPercent()) + 
 # scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        axis.title.x=element_blank()) +
  ggtitle("Percentage of Users Uniquely Seen by Campaign per Day")

ggsave(paste(imageLocation, "UniqueUsersPerCampaign.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g
```
```{r include=TRUE, echo=FALSE}
library(scales)
path = "~/Documents/ETH/Thesis/1plusX/Data/RawData/Multi-Campaign/Processed/MultiCampaignUserStats.csv"
data <- read.csv(file=path, header=TRUE, sep=",")
data$Date = as.Date(data$Date)

g = ggplot(data, aes(fill=factor(CampaignCount), y=UserCount, x=Date)) +
  geom_bar( stat="identity") +
  theme_bw() +
  ylab("User Count") +
  scale_y_continuous(labels=formatterK()) + 
  scale_fill_discrete(name="# Observed Campaigns") +
  #scale_x_datetime(breaks = date_breaks("1 day"), labels = date_format("%b %e")) +
  theme(axis.text.x=element_text(angle = 45, hjust = 1, size=7),
        axis.title.x=element_blank()) +
  ggtitle("% Users grouped by # Observed Campaigns")

ggsave(paste(imageLocation, "UsersGroupsPerCampaign.png", sep=""), plot=g, width = 20, height = 11, units = "cm")
g

```

